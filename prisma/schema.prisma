generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id                    String                   @id @default(cuid())
  name                  String
  email                 String                   @unique
  passwordHash          String
  role                  UserRole                 @default(Member)
  stripeCustomerId      String?                  @unique
  stripeSubscriptionId  String?                  @unique
  subscriptionStatus    String?
  subscriptionTier      SubscriptionTier         @default(Free)
  createdAt             DateTime                 @default(now())
  updatedAt             DateTime                 @updatedAt
  sessions              Session[]
  businesses            Business[]               @relation("BusinessOwner")
  listingRequests       BusinessListingRequest[] @relation("ListingRequester")
  businessEditRequests  BusinessEditRequest[]
  businessClaimRequests BusinessClaimRequest[]
}

model Session {
  id        String   @id @default(cuid())
  tokenHash String   @unique
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([expiresAt])
}

model Business {
  id            String                 @id @default(cuid())
  name          String
  slug          String                 @unique
  summary       String
  description   String
  category      String
  phone         String?
  email         String?
  website       String?
  address       String
  postcode      String
  area          String
  verified      Boolean                @default(false)
  createdAt     DateTime               @default(now())
  updatedAt     DateTime               @updatedAt
  interactions  BusinessInteraction[]
  jobs          Job[]
  events        Event[]
  ownerUserId   String?
  owner         User?                  @relation("BusinessOwner", fields: [ownerUserId], references: [id], onDelete: SetNull)
  editRequests  BusinessEditRequest[]
  claimRequests BusinessClaimRequest[]

  @@index([name])
  @@index([category])
  @@index([area])
  @@index([ownerUserId])
}

model BusinessClaimRequest {
  id         String        @id @default(cuid())
  businessId String
  business   Business      @relation(fields: [businessId], references: [id], onDelete: Cascade)
  userId     String
  user       User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  note       String?
  status     RequestStatus @default(Pending)
  createdAt  DateTime      @default(now())

  @@unique([businessId, userId, status])
  @@index([businessId, createdAt(sort: Desc)])
  @@index([userId, createdAt(sort: Desc)])
  @@index([status])
}

model BusinessInteraction {
  id         String          @id @default(cuid())
  businessId String
  business   Business        @relation(fields: [businessId], references: [id], onDelete: Cascade)
  type       InteractionType
  createdAt  DateTime        @default(now())

  @@index([businessId, createdAt])
  @@index([type, createdAt])
}

model BusinessListingRequest {
  id                String        @id @default(cuid())
  businessName      String
  contactName       String
  contactEmail      String
  contactPhone      String?
  website           String?
  category          String
  area              String
  description       String
  preferredCallTime String?
  status            RequestStatus @default(Pending)
  createdAt         DateTime      @default(now())
  requesterUserId   String?
  requester         User?         @relation("ListingRequester", fields: [requesterUserId], references: [id], onDelete: SetNull)

  @@index([status])
  @@index([createdAt(sort: Desc)])
  @@index([requesterUserId])
}

model BusinessEditRequest {
  id          String        @id @default(cuid())
  businessId  String
  business    Business      @relation(fields: [businessId], references: [id], onDelete: Cascade)
  ownerUserId String
  owner       User          @relation(fields: [ownerUserId], references: [id], onDelete: Cascade)
  name        String
  summary     String
  description String
  category    String
  phone       String?
  email       String?
  website     String?
  address     String
  postcode    String
  area        String
  status      RequestStatus @default(Pending)
  createdAt   DateTime      @default(now())

  @@index([businessId, createdAt(sort: Desc)])
  @@index([ownerUserId, createdAt(sort: Desc)])
  @@index([status])
}

model Job {
  id               String           @id @default(cuid())
  title            String
  company          String
  summary          String
  type             String
  salary           String?
  location         String
  applyUrl         String?
  publishedAt      DateTime         @default(now())
  closesAt         DateTime?
  businessId       String?
  business         Business?        @relation(fields: [businessId], references: [id], onDelete: SetNull)
  interactions     JobInteraction[]
  manuallyFeatured Boolean          @default(false)

  @@index([publishedAt(sort: Desc)])
  @@index([businessId])
}

model JobInteraction {
  id        String                 @id @default(cuid())
  jobId     String
  job       Job                    @relation(fields: [jobId], references: [id], onDelete: Cascade)
  type      ContentInteractionType
  createdAt DateTime               @default(now())

  @@index([jobId, createdAt])
}

model JobSubmission {
  id           String        @id @default(cuid())
  title        String
  company      String
  summary      String
  type         String
  salary       String?
  location     String
  applyUrl     String?
  contactEmail String
  status       RequestStatus @default(Pending)
  createdAt    DateTime      @default(now())

  @@index([status])
  @@index([createdAt(sort: Desc)])
}

model Event {
  id               String             @id @default(cuid())
  title            String
  summary          String
  venue            String
  area             String
  startsAt         DateTime
  endsAt           DateTime?
  price            String?
  bookingUrl       String?
  createdAt        DateTime           @default(now())
  businessId       String?
  business         Business?          @relation(fields: [businessId], references: [id], onDelete: SetNull)
  interactions     EventInteraction[]
  manuallyFeatured Boolean            @default(false)

  @@index([startsAt])
  @@index([businessId])
}

model EventInteraction {
  id        String                 @id @default(cuid())
  eventId   String
  event     Event                  @relation(fields: [eventId], references: [id], onDelete: Cascade)
  type      ContentInteractionType
  createdAt DateTime               @default(now())

  @@index([eventId, createdAt])
}

model EventSubmission {
  id           String        @id @default(cuid())
  title        String
  summary      String
  venue        String
  area         String
  startsAt     DateTime
  endsAt       DateTime?
  price        String?
  bookingUrl   String?
  contactEmail String
  status       RequestStatus @default(Pending)
  createdAt    DateTime      @default(now())

  @@index([status])
  @@index([startsAt])
}

model NewsArticle {
  id          String   @id @default(cuid())
  title       String
  summary     String
  body        String
  source      String
  sourceUrl   String?
  area        String
  publishedAt DateTime @default(now())

  @@index([publishedAt(sort: Desc)])
}

model NewsSubmission {
  id           String        @id @default(cuid())
  title        String
  summary      String
  body         String
  source       String
  sourceUrl    String?
  area         String
  contactEmail String
  status       RequestStatus @default(Pending)
  createdAt    DateTime      @default(now())

  @@index([status])
  @@index([createdAt(sort: Desc)])
}

model Charity {
  id        String   @id @default(cuid())
  name      String
  summary   String
  mission   String
  area      String
  website   String?
  email     String?
  phone     String?
  createdAt DateTime @default(now())

  @@index([name])
  @@index([area])
}

model CharitySubmission {
  id           String        @id @default(cuid())
  name         String
  summary      String
  mission      String
  area         String
  website      String?
  email        String?
  phone        String?
  contactEmail String
  status       RequestStatus @default(Pending)
  createdAt    DateTime      @default(now())

  @@index([status])
  @@index([createdAt(sort: Desc)])
}

model PlanInterest {
  id           String   @id @default(cuid())
  plan         String
  company      String
  contactName  String
  contactEmail String
  notes        String?
  createdAt    DateTime @default(now())

  @@index([createdAt(sort: Desc)])
}

enum UserRole {
  Member
  Admin
}

enum SubscriptionTier {
  Free
  Growth
  TownPartner
}

enum RequestStatus {
  Pending
  Approved
  Rejected
}

enum InteractionType {
  View
  WebsiteClick
  ContactClick
}

enum ContentInteractionType {
  View
  Click
}
